# Security Configuration Assessment
# CIS Checks for RHEL 7
# Copyright (C) 2015-2020, Wazuh Inc.
#
# This program is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public
# License (version 2) as published by the FSF - Free Software
# Foundation
#
# Based on:
# Center for Internet Security Red Hat Enterprise Linux 7 Benchmark v2.2.0 - 12-27-2017

policy:
  id: "cis_rhel7_workstationL2"
  file: "cis_rhel7_workstationL2.yml"
  name: "CIS Benchmark for Red Hat Enterprise Linux 7"
  description: "This document provides prescriptive guidance for establishing a secure configuration posture for Red Hat Enterprise Linux 7 systems running on x86 and x64 platforms. This document was tested against Red Hat Enterprise Linux 7.4."
  references:
    - https://www.cisecurity.org/cis-benchmarks/

requirements:
  title: "Check RHEL7 family platform"
  description: "Requirements for running the policy against RHEL 7 family."
  condition: any
  rules:
    - 'f:/etc/redhat-release -> r:^Red Hat Enterprise Linux && r:release 7'
    - 'f:/etc/redhat-release -> r:^Cloud && r:release 7'
    - 'f:/etc/redhat-release -> r:^Oracle && r:release 7'
    - 'f:/etc/redhat-release -> r:^Better && r:release 7'
    - 'f:/etc/redhat-release -> r:^OpenVZ && r:release 7'
    - 'f:/etc/system-release -> r:^Amazon && r:release 2'

variables:
  $sshd_file: /etc/ssh/sshd_config

checks:


# 1.1.1.8 FAT: filesystem
  - id: 6200 
    title: "Ensure mounting of FAT filesystems is disabled"
    description: "The FAT filesystem format is primarily used on older windows systems and portable USB drives or flash modules. It comes in three types FAT12 , FAT16 , and FAT32 all of which are supported by the vfat kernel module."
    rationale: "Removing support for unneeded filesystem types reduces the local attack surface of the system. If this filesystem type is not needed, disable it."
    remediation: "Edit or create the file /etc/modprobe.d/CIS.conf and add the following line: install vfat /bin/true. Run the following command to unload the vfat module: rmmod vfat"
    compliance:
      - cis: ["1.1.1.8"]
      - cis_csc: ["13"]
      - pci_dss: ["2.2.5"]
      - tsc: ["CC6.3"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:modprobe -n -v vfat -> r:install /bin/true|Module vfat not found'
      - 'not c:lsmod -> r:vfat'

  # 1.1.2 /tmp: partition
  - id: 6201 
    title: "Ensure separate partition exists for /tmp"
    description: "The /tmp directory is a world-writable directory used for temporary storage by all users and some applications."
    rationale: "Since the /tmp directory is intended to be world-writable, there is a risk of resource exhaustion if it is not bound to a separate partition. In addition, making /tmp its own file system allows an administrator to set the noexec option on the mount, making /tmp useless for an attacker to install executable code. It would also prevent an attacker from establishing a hardlink to a system setuid program and wait for it to be updated. Once the program was updated, the hardlink would be broken and the attacker would have his own copy of the program. If the program happened to have a security vulnerability, the attacker could continue to exploit the known flaw."
    remediation: "For new installations, during installation create a custom partition setup and specify a separate partition for /tmp. For systems that were previously installed, create a new partition for /tmp if not using tmpfs. Enable systemd /tmp mounting"
    compliance:
      - cis: ["1.1.2"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/tmp\s'


# 1.1.6 Build considerations - Partition scheme.
  - id: 6202 
    title: "Ensure separate partition exists for /var"
    description: "The /var directory is used by daemons and other system services to temporarily store dynamic data. Some directories created by these processes may be world-writable."
    rationale: "Since the /var directory may contain world-writable files and directories, there is a risk of resource exhaustion if it is not bound to a separate partition."
    remediation: "For new installations, during installation create a custom partition setup and specify a separate partition for /var. For systems that were previously installed, create a new partition and configure /etc/fstab as appropriate."
    compliance:
      - cis: ["1.1.6"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/var\s'

# 1.1.7 bind mount /var/tmp to /tmp
  - id: 6203 
    title: "Ensure separate partition exists for /var/tmp"
    description: "The /var/tmp directory is a world-writable directory used for temporary storage by all users and some applications."
    rationale: "Since the /var/tmp directory is intended to be world-writable, there is a risk of resource exhaustion if it is not bound to a separate partition. In addition, making /var/tmp its own file system allows an administrator to set the noexec option on the mount, making /var/tmp useless for an attacker to install executable code."
    remediation: "For new installations, during installation create a custom partition setup and specify a separate partition for /var/tmp. For systems that were previously installed, create a new partition and configure /etc/fstab as appropriate."
    compliance:
      - cis: ["1.1.7"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:mount -> r:\s/var/tmp\s'






# 1.1.11 /var/log: partition
  - id: 6204 
    title: "Ensure separate partition exists for /var/log"
    description: "The /var/log directory is used by system services to store log data ."
    rationale: "There are two important reasons to ensure that system logs are stored on a separate partition: protection against resource exhaustion (since logs can grow quite large) and protection of audit data."
    remediation: "For new installations, during installation create a custom partition setup and specify a separate partition for /var/log. For systems that were previously installed, create a new partition and configure /etc/fstab as appropriate."
    compliance:
      - cis: ["1.1.11"]
      - cis_csc: ["6.3"]
      - pci_dss: ["2.2.4","10.7"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/var/log\s'

# 1.1.12 /var/log/audit: partition
  - id: 6205 
    title: "Ensure separate partition exists for /var/log/audit"
    description: "The auditing daemon, auditd , stores log data in the /var/log/audit directory."
    rationale: "There are two important reasons to ensure that data gathered by auditd is stored on a separate partition: protection against resource exhaustion (since the audit.log file can grow quite large) and protection of audit data."
    remediation: "For new installations, during installation create a custom partition setup and specify a separate partition for /var/log/audit. For systems that were previously installed, create a new partition and configure /etc/fstab as appropriate."
    compliance:
      - cis: ["1.1.12"]
      - cis_csc: ["6.3"]
      - pci_dss: ["2.2.4","10.7"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/var/log/audit\s'

# 1.1.13 /home: partition
  - id: 6206 
    title: "Ensure separate partition exists for /home"
    description: "The /home directory is used to support disk storage needs of local users."
    rationale: "If the system is intended to support local users, create a separate partition for the /home directory to protect against resource exhaustion and restrict the type of files that can be stored under /home."
    remediation: "For new installations, during installation create a custom partition setup and specify a separate partition for /home. For systems that were previously installed, create a new partition and configure /etc/fstab as appropriate."
    compliance:
      - cis: ["1.1.13"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    references:
      - AJ Lewis, "LVM HOWTO", https://tldp.org/HOWTO/LVM-HOWTO/
    condition: all
    rules:
      - 'c:mount -> r:\s/home\s'


###############################################
# 1.2 Configure Software Updates
###############################################

# 1.2.5 Disable the rhnsd Daemon (Not Scored)
  - id: 6207 
    title: "Disable the rhnsd Daemon"
    description: "The rhnsd daemon polls the Red Hat Network web site for scheduled actions and, if there are, executes those actions."
    rationale: "Patch management policies may require that organizations test the impact of a patch before it is deployed in a production environment. Having patches automatically deployed could have a negative impact on the environment. It is best to not allow an action by default but only after appropriate consideration has been made. It is recommended that the service be disabled unless the risk is understood and accepted or you are running your own satellite . This item is not scored because organizations may have addressed the risk."
    remediation: "Run the following command to disable rhnsd : # chkconfig rhnsd off"
    compliance:
      - cis: ["1.2.5"]
      - pci_dss: ["2.2.5"]
      - tsc: ["CC6.3"]
    condition: all
    rules:
      - 'c:chkconfig --list rhnsd -> r:^rhnsd\s*\t*0:off\s*\t*1:off\s*\t*2:off\s*\t*3:off\s*\t*4:off\s*\t*5:off\s*\t*6:off'

 
 ###############################################
# 1.6 Configure SELinux
###############################################
# 1.6.1.1 SELinux not disabled
  - id: 6208 
    title: "Ensure SELinux is not disabled in bootloader configuration"
    description: "Configure SELINUX to be enabled at boot time and verify that it has not been overwritten by the grub boot parameters."
    rationale: "SELinux must be enabled at boot time in your grub configuration to ensure that the controls it provides are not overridden."
    remediation: "Edit /etc/default/grub and remove all instances of selinux=0 and enforcing=0 from all CMDLINE_LINUX parameters: GRUB_CMDLINE_LINUX_DEFAULT=\"quiet\" GRUB_CMDLINE_LINUX=\"\"  || Run the following command to update the grub2 configuration: grub2-mkconfig -o /boot/grub2/grub.cfg"
    compliance:
      - cis: ["1.6.1.1"]
      - cis_csc: ["14.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - 'f:/boot/grub2/grub.cfg -> r:linux\.+selinux=0|linux\.+enforcing=0'
# 1.6.1.2 Set selinux state
  - id: 6209 
    title: "Ensure the SELinux state is enforcing"
    description: "Set SELinux to enable when the system is booted."
    rationale: "SELinux must be enabled at boot time in to ensure that the controls it provides are in effect at all times."
    remediation: "Edit the /etc/selinux/config file to set the SELINUX parameter: SELINUX=enforcing"
    compliance:
      - cis: ["1.6.1.2"]
      - cis_csc: ["14.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sestatus -> r:^SELinux status:\s+enabled$'
      - 'c:sestatus -> r:^Current mode:\s+enforcing$'
      - 'c:sestatus -> r:^Mode from config file:\s+enforcing$'
      - 'f:/etc/selinux/config -> r:^SELINUX=enforcing'

# 1.6.1.3 Set selinux policy
  - id: 6210 
    title: "Ensure SELinux policy is configured"
    description: "Configure SELinux to meet or exceed the default targeted policy, which constrains daemons and system software only."
    rationale: "Security configuration requirements vary from site to site. Some sites may mandate a policy that is stricter than the default policy, which is perfectly acceptable. This item is intended to ensure that at least the default recommendations are met."
    remediation: "Edit the /etc/selinux/config file to set the SELINUXTYPE parameter: SELINUXTYPE=targeted"
    compliance:
      - cis: ["1.6.1.3"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:sestatus -> r:^Loaded policy name:\s+targeted$'
      - 'f:/etc/selinux/config -> r:^\s*SELINUXTYPE\s*=\s*targeted|^\s*SELINUXTYPE\s*=\s*mls'



# 1.6.1.5 Disable MCS Translation service mcstrans
  - id: 6211 
    title: "Ensure the MCS Translation Service (mcstrans) is not installed"
    description: "The mcstransd daemon provides category label information to client processes requesting information. The label translations are defined in /etc/selinux/targeted/setrans.conf"
    rationale: "Since this service is not used very often, remove it to reduce the amount of potentially vulnerable code running on the system."
    remediation: "Run the following command to uninstall mcstrans: # yum remove mcstrans"
    compliance:
      - cis: ["1.6.1.5"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - 'c:rpm -qa mcstrans -> r:mcstrans'

# 1.6.1.6 Ensure no unconfined daemons exist
  - id: 6212 
    title: "Ensure no unconfined daemons exist"
    description: "Daemons that are not defined in SELinux policy will inherit the security context of their parent process."
    rationale: "Since daemons are launched and descend from the init process, they will inherit the security context label initrc_t . This could cause the unintended consequence of giving the process more permission than it requires."
    remediation: "Investigate any unconfined daemons found during the audit action. They may need to have an existing security context assigned to them or a policy built for them."
    compliance:
      - cis: ["1.6.1.6"]
      - cis_csc: ["14.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - 'c:ps -eZ -> r:initrc && !r:tr|ps|egrep|bash|awk'

# 1.6.2 Install SELinux
  - id: 6213 
    title: "Ensure SELinux is installed"
    description: "SELinux provides Mandatory Access Controls."
    rationale: "Without a Mandatory Access Control system installed only the default Discretionary Access Control system will be available."
    remediation: "Run the following command to install libselinux: yum install libselinux"
    compliance:
      - cis: ["1.6.2"]
      - cis_csc: ["14.4"]
      - pci_dss: ["2.2.4"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: all
    rules:
      - 'c:rpm -q libselinux -> r:libselinux-\S+'



###############################################
# 2 OS Services
###############################################
###############################################
# 2.2 Remove Legacy Services
###############################################
# 2.2.4 Ensure CUPS is not enabled (Scored)
  - id: 6214 
    title: "Ensure CUPS is not enabled"
    description: "The Common Unix Print System (CUPS) provides the ability to print to both local and network printers. A system running CUPS can also accept print jobs from remote systems and print them to local printers. It also provides a web based remote administration capability."
    rationale: "If the system does not need to print jobs or accept print jobs from other systems, it is recommended that CUPS be disabled to reduce the potential attack surface."
    remediation: "Run the following command to disable cups : # systemctl disable cups"
    compliance:
      - cis: ["2.2.4"]
      - cis_csc: ["9.1"]
      - pci_dss: ["2.2.2"]
      - nist_800_53: ["CM.1"]
      - tsc: ["CC5.2"]
    condition: none
    rules:
      - 'c:systemctl is-enabled cups -> r:^enabled'


# 5.4.5 Ensure default user shell timeout is 900 seconds or less (Scored)
  - id: 6215 
    title: "Ensure default user shell timeout is 900 seconds or less"
    description: "The default TMOUT determines the shell timeout for users. The TMOUT value is measured in seconds."
    rationale: "Having no timeout value associated with a shell could allow an unauthorized user access to another user's shell session (e.g. user walks away from their computer and doesn't lock the screen). Setting a timeout value at least reduces the risk of this happening."
    remediation: "Edit the /etc/bashrc and /etc/profile files (and the appropriate files for any other shell supported on your system) and add or edit any umask parameters as follows: TMOUT=600"
    compliance:
      - cis: ["5.4.5"]
      - cis_csc: ["16.4"]
      - pci_dss: ["12.3.8"]
    condition: all
    rules:
      - 'not f:/etc/bashrc -> n:^\s*\t*TMOUT\s*\t*=\s*\t*(\d+) compare > 900'
      - 'not f:/etc/profile -> n:^\s*\t*TMOUT\s*\t*=\s*\t*(\d+) compare > 900'
      - 'f:/etc/bashrc -> n:^\s*\t*TMOUT\s*\t*=\s*\t*(\d+) compare <= 900'
      - 'f:/etc/profile -> n:^\s*\t*TMOUT\s*\t*=\s*\t*(\d+) compare <= 900'





